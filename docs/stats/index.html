<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Stats - go-msx</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "coal" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../CONTRIBUTING.html">Contributing</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Cross-Cutting Concerns</li><li class="chapter-item expanded "><a href="../log/index.html"><strong aria-hidden="true">1.</strong> Logging</a></li><li class="chapter-item expanded "><a href="../types/docs/errors.html"><strong aria-hidden="true">2.</strong> Errors</a></li><li class="chapter-item expanded "><a href="../config/index.html"><strong aria-hidden="true">3.</strong> Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/consulprovider/index.html"><strong aria-hidden="true">3.1.</strong> Consul Configuration Provider</a></li></ol></li><li class="chapter-item expanded "><a href="../app/index.html"><strong aria-hidden="true">4.</strong> Lifecycle</a></li><li class="chapter-item expanded "><a href="../app/context.html"><strong aria-hidden="true">5.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../stats/index.html" class="active"><strong aria-hidden="true">6.</strong> Stats</a></li><li class="chapter-item expanded "><a href="../trace/index.html"><strong aria-hidden="true">7.</strong> Tracing</a></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Application Components</li><li class="chapter-item expanded "><a href="../webservice/controller.html"><strong aria-hidden="true">8.</strong> Controller</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">9.</strong> Filter</div></li><li class="chapter-item expanded "><a href="../sqldb/repository.html"><strong aria-hidden="true">10.</strong> Repository</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">11.</strong> Migration</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">12.</strong> Integration</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../integration/docs/openapi.html"><strong aria-hidden="true">12.1.</strong> OpenAPI Client ðŸŽ‰</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.</strong> Streaming</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ops/streamops/index.html"><strong aria-hidden="true">13.1.</strong> Stream Operations ðŸŽ‰</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ops/streamops/ports.html"><strong aria-hidden="true">13.1.1.</strong> Ports</a></li><li class="chapter-item expanded "><a href="../ops/streamops/validation.html"><strong aria-hidden="true">13.1.2.</strong> Validation</a></li><li class="chapter-item expanded "><a href="../ops/streamops/publishers.html"><strong aria-hidden="true">13.1.3.</strong> Publishers</a></li><li class="chapter-item expanded "><a href="../ops/streamops/subscribers.html"><strong aria-hidden="true">13.1.4.</strong> Subscribers</a></li><li class="chapter-item expanded "><a href="../schema/asyncapi/index.html"><strong aria-hidden="true">13.1.5.</strong> AsyncApi</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.</strong> Stream Providers</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.1.</strong> Kafka</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.2.</strong> SQL</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.3.</strong> GoChannel</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">13.2.4.</strong> Redis</div></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">Utilities</li><li class="chapter-item expanded "><div><strong aria-hidden="true">14.</strong> Audit Events</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">15.</strong> Auditable Models</div></li><li class="chapter-item expanded "><a href="../cache/lru/index.html"><strong aria-hidden="true">16.</strong> Cache</a></li><li class="chapter-item expanded "><a href="../certificate/index.html"><strong aria-hidden="true">17.</strong> Certificates and TLS</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">18.</strong> Executing Commands</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">19.</strong> Health Checks</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">20.</strong> Http Client</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">21.</strong> Leader Election</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">22.</strong> Pagination</div></li><li class="chapter-item expanded "><a href="../resource/index.html"><strong aria-hidden="true">23.</strong> Resources</a></li><li class="chapter-item expanded "><a href="../retry/index.html"><strong aria-hidden="true">24.</strong> Retry</a></li><li class="chapter-item expanded "><a href="../sanitize/index.html"><strong aria-hidden="true">25.</strong> Sanitization</a></li><li class="chapter-item expanded "><a href="../scheduled/index.html"><strong aria-hidden="true">26.</strong> Scheduled Tasks</a></li><li class="chapter-item expanded "><a href="../transit/index.html"><strong aria-hidden="true">27.</strong> Transit Encryption</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">28.</strong> Validation</div></li><li class="spacer"></li><li class="chapter-item expanded affix "><li class="part-title">Code Generation</li><li class="chapter-item expanded "><a href="../skel/index.html"><strong aria-hidden="true">29.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../skel/docs/installation.html"><strong aria-hidden="true">30.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../skel/docs/usage.html"><strong aria-hidden="true">31.</strong> Usage</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">32.</strong> Projects</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../skel/docs/projects-generic.html"><strong aria-hidden="true">32.1.</strong> Generic Microservice</a></li><li class="chapter-item expanded "><a href="../skel/docs/projects-beats.html"><strong aria-hidden="true">32.2.</strong> Probes (Beats)</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">32.3.</strong> Service Pack Microservice</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">32.4.</strong> Service Pack UI</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">33.</strong> Continuous Integration</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">34.</strong> Web Services</div></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">34.1.</strong> Domains</div></li><li class="chapter-item expanded "><div><strong aria-hidden="true">34.2.</strong> OpenAPI</div></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">35.</strong> Stream Services</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../skel/asyncapi/channels.html"><strong aria-hidden="true">35.1.</strong> Channels</a></li><li class="chapter-item expanded "><a href="../skel/asyncapi/spec.html"><strong aria-hidden="true">35.2.</strong> AsyncAPI</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Builds ðŸŽ‰</li><li class="chapter-item expanded "><div><strong aria-hidden="true">36.</strong> Introduction</div></li><li class="chapter-item expanded "><a href="../build/docs/usage-make.html"><strong aria-hidden="true">37.</strong> Makefile Usage</a></li><li class="chapter-item expanded "><a href="../build/docs/usage-build.html"><strong aria-hidden="true">38.</strong> Build Usage</a></li><li class="chapter-item expanded "><a href="../build/docs/config.html"><strong aria-hidden="true">39.</strong> Configuration</a></li><li class="chapter-item expanded "><a href="../build/docs/targets.html"><strong aria-hidden="true">40.</strong> Build Targets</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../build/docs/targets-project.html"><strong aria-hidden="true">40.1.</strong> Project Maintenance</a></li><li class="chapter-item expanded "><a href="../build/docs/targets-development.html"><strong aria-hidden="true">40.2.</strong> Development</a></li><li class="chapter-item expanded "><a href="../build/docs/targets-artifacts.html"><strong aria-hidden="true">40.3.</strong> Artifacts</a></li><li class="chapter-item expanded "><a href="../build/docs/targets-verification.html"><strong aria-hidden="true">40.4.</strong> Verification</a></li><li class="chapter-item expanded "><a href="../build/docs/targets-publishing.html"><strong aria-hidden="true">40.5.</strong> Publishing</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><li class="part-title">Continuous Integration</li><li class="chapter-item expanded "><a href="../checks/index.html"><strong aria-hidden="true">41.</strong> Checks ðŸŽ‰</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">42.</strong> Jenkins</div></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">go-msx</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="msx-statistics"><a class="header" href="#msx-statistics">MSX Statistics</a></h1>
<p>MSX Statistics allows applications to monitor and record application metrics for display on dashboards and generation of application alarms.  We have chosen to support Prometheus and its OpenMetrics format to expose collected data.</p>
<h2 id="statistics-types"><a class="header" href="#statistics-types">Statistics Types</a></h2>
<p>MSX Statistics supports several base data collection types:</p>
<ul>
<li>
<p><strong>Counter</strong></p>
<p>A counter is an ever-increasing number. For example, &quot;Completed Requests&quot; will continuously increase throughout the lifetime of the application.  It is initialized to zero on application startup.</p>
</li>
<li>
<p><strong>Gauge</strong></p>
<p>A gauge is a metric that represents a single numerical value that can arbitrarily go up and down. For example, &quot;Active Requests&quot; increases when a new request arrives, and decreases when a request is fully serviced.</p>
</li>
<li>
<p><strong>Histogram</strong></p>
<p>A histogram samples observations (usually things like request durations or response sizes) and counts them in configurable buckets. It also provides a sum of all observed values.  For example, &quot;Query Duration&quot; has a range of time values (from 0 seconds and up).  These can be put into buckets to see what the 99th percentile Query Duration is (using the prometheus <code>histogram_quantile</code> function in the dashboard).</p>
</li>
</ul>
<p>If you wish to further group the data, you can use the Vector version of each of the above types.  For example, we can group a &quot;Request Duration Histogram&quot; by API endpoint, in order to see the distribution of request duration distributions for each endpoint separated from other endpoints.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<h3 id="instantiation"><a class="header" href="#instantiation">Instantiation</a></h3>
<p>To start collecting a statistic, you must first initialize its collector.  This can be accomplished during module initialization by assigning the collector to a module-global variable:</p>
<pre><code class="language-go">const (
    statsSubsystemConsul               = &quot;consul&quot;
    statsHistogramConsulCallTime       = &quot;call_time&quot;
    statsGaugeConsulCalls              = &quot;calls&quot;
    statsCounterConsulCallErrors       = &quot;call_errors&quot;
    statsGaugeConsulRegisteredServices = &quot;registrations&quot;
)

var (
    // Collect the number of errors for each api
    countVecConsulCallErrors = stats.NewCounterVec(
        statsSubsystemConsul, 
        statsCounterConsulCallErrors, 
        &quot;api&quot;, &quot;param&quot;)

    // Collect the number of active requests for each api
    gaugeVecConsulCalls      = stats.NewGaugeVec(
        statsSubsystemConsul, 
        statsGaugeConsulCalls, 
        &quot;api&quot;, &quot;param&quot;)

    // Collect the distribution of call execution times for each api
    histVecConsulCallTime    = stats.NewHistogramVec(
        statsSubsystemConsul, 
        statsHistogramConsulCallTime, 
        nil, 
        &quot;api&quot;, &quot;param&quot;)
)
</code></pre>
<p>As you can see above, each of the collector constructors start with two required arguments:</p>
<ul>
<li>
<p><strong>Subsystem</strong></p>
<p>Identifies the application subsystem being monitored.  In this case, <code>consul</code>.</p>
</li>
<li>
<p><strong>Metric Name</strong></p>
<p>Identifies the individual metric dimension.  By convention, duration histograms end with <code>_time</code>, and counters are pluralized.</p>
</li>
</ul>
<p>The histogram (and histogram vector) constructors require an argument specifying the buckets and their upper limits.  To use the default buckets, pass <code>nil</code> for this argument.  The current default buckets are calculated by executing <code>prometheus.ExponentialBuckets(10, 2, 16)</code>: this evaluates to <code>[10, 20, 40, ..., 655360]</code>.  For more information about histograms, you can visit the <a href="https://prometheus.io/docs/practices/histograms/">Prometheus documentation</a>.</p>
<p>Vector constructors, as shown above, accept a final series of dimensions to be applied to each of the measurements.  In the example above, each of our vectors accepts the <code>api</code> and <code>param</code> groupings.  In the consul stats collector:</p>
<ul>
<li><code>api</code> identifies which Consul API endpoint is being called (by path)</li>
<li><code>param</code> identifies eg. the servicename for discovery</li>
</ul>
<h3 id="collection"><a class="header" href="#collection">Collection</a></h3>
<p>After initializing your collectors, you can start to measure your application as the relevant events occur.</p>
<p>A common pattern is define a wrapper function whose only purpose is to collect statistics.  In the Consul package, we can see an example of this:</p>
<pre><code class="language-go">func observeConsulCall(api, param string, fn func() error) (err error) {
    // Collect the start time of the call
    start := time.Now()
    // Increase the number of active calls
    gaugeVecConsulCalls.WithLabelValues(api, param).Inc()

    // Execute this code before returning, even in case of panic()
    defer func() {
        // Reduce the number of active calls
        gaugeVecConsulCalls.WithLabelValues(api, param).Dec()
        
        // Bucket the call duration in the histogram
        histVecConsulCallTime.WithLabelValues(api, param).Observe(
            float64(time.Since(start)) / float64(time.Millisecond))

        if err != nil {
            // Increase the error count if an error was returned from fn
            countVecConsulCallErrors.WithLabelValues(api, param).Inc()
        }
    }()

    // Call the wrapped function and intercept it's error return value
    err = fn()
    
    // Return the wrapped function's value, after the defer block
    return err
}
</code></pre>
<p>There are a few things to note here not covered in the inline comments:</p>
<ol>
<li>We directly pass <code>api</code> and <code>param</code> group values to each of the vectors from the wrapper using <code>.WithLabelValues()</code>.  These must be passed in the same order as in the constructor.</li>
<li>Time periods should be calculated as <code>float64</code> milliseconds.</li>
<li>Counters and Gauges can be incremented by <code>1.0</code> using the <code>.Inc()</code> method.</li>
<li>Gauges can be decremented by <code>1.0</code> using the <code>.Dec()</code> method.</li>
<li>Histograms can record an observation using the <code>.Observe()</code> method.</li>
</ol>
<h2 id="push-gateway"><a class="header" href="#push-gateway">Push Gateway</a></h2>
<p>By default, the MSX Statistics package expects the statistics to be polled by an external application.  If such a poller is not available, MSX Statistics can be configured to push
to an external Prometheus push gateway.</p>
<h3 id="configuration"><a class="header" href="#configuration">Configuration</a></h3>
<p>The following configuration settings can be specified to configure the stats pusher:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th>Description</th><th>Default</th></tr></thead><tbody>
<tr><td><code>stats.push.enabled</code></td><td>enable the stats pusher</td><td><code>false</code></td></tr>
<tr><td><code>stats.push.url</code></td><td>url to push stats too</td><td></td></tr>
<tr><td><code>stats.push.job-name</code></td><td>prometheus job name to send</td><td><code>go_msx</code></td></tr>
<tr><td><code>stats.push.frequency</code></td><td>duration between pushes</td><td><code>15s</code></td></tr>
</tbody></table>
</div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../app/context.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../trace/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../app/context.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../trace/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../book/mermaid.min.js"></script>
        <script type="text/javascript" src="../book/mermaid-init.js"></script>
    </body>
</html>
